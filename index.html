<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alert Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .navbar-brand img {
            max-height: 110px;
            width: auto;
        }

        .alert-card {
            transition: all 0.3s ease;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .alert-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        .alert-header {
            border-radius: 15px 15px 0 0;
            padding: 15px;
            font-weight: bold;
        }

        .alert-body {
            padding: 20px;
        }

        .filter-section {
            background-color: #ffffff;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .main-content {
            flex: 1 0 auto;
        }

        footer {
            flex-shrink: 0;
            background-color: #343a40;
            color: #ffffff;
            padding: 20px 0;
            margin-top: 40px;
        }

        .rollup-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .rollup-card {
            display: flex;
            flex-direction: column;
            border-radius: 15px;
            border: 4px solid var(--bs-primary-border-subtle);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            background-color: #ffffff;
            min-height: 200px;
        }

        .rollup-card .count {
            font-size: 300%;
            font-weight: bolder;
        }

        .rollup-card-header {
            font-size: 20pt;
            font-weight: bold;
        }

        .rollup-card-body {
            margin-top: auto;
            /* Pushes the body to the bottom */
        }

        div.sensortype-icon {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-repeat: no-repeat;
            top: 8px;
            position: relative;
        }

        .type-246,
        .type-243,
        .type-244,
        .type-245,
        .type-242 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/temperature30x30.png');
        }

        .type-248 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/rh30x30.png');
        }

        .type-181 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/CO2-30x30.png');
        }

        .type-182 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/eCO2-30x30.png');
        }

        .type-100,
        .type-99 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/pressure.png');
        }

        .type-96 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/VOCicon.png');
        }

        .type-64 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/CO.png');
        }

        .type-32,
        .type-33,
        .type-34,
        .type-35,
        .type-36,
        .type-37,
        .type-38,
        .type-39,
        .type-40 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/PM\ icon.png');
        }

        .type-49,
        .type-50,
        .type-51 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/volume-icon.png');
        }

        .type-115 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/light-icon.png');
        }

        .type-52,
        .type-53,
        .type-54 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/vibration-30x30.png');
        }

        .type-28 {
            background-image: url('https://iot.aretas.ca/html/images/sensortypes/AQI-30x30.png')
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <nav class="col-lg-2 col-md-3 col-sm-4 bg-dark navbar-dark vh-100">
                <div class="d-flex flex-column align-items-start p-3">
                    <a class="navbar-brand" href="#">
                        <img src="images/legacy-sensors-website-logo.png" alt="Logo" class="img-fluid mb-4">
                    </a>
                    <ul class="navbar-nav flex-column w-100">
                        <li class="nav-item">
                            <a class="nav-link active" href="#">Dashboard</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Alerts</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Settings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#">Profile</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main Content Area -->
            <main class="col-lg-10 col-md-9 col-sm-8 main-content">
                <div class="container mt-2">
                    <h1 class="text-center mb-2">Alert Notice Dashboard</h1>
                    <div class="filter-section">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="alertIdFilter" class="form-label">Filter by Alert ID:</label>
                                <select id="alertIdFilter" class="form-select">
                                    <option value="">All Alert IDs</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="sensorTypeFilter" class="form-label">Filter by Sensor Type:</label>
                                <select id="sensorTypeFilter" class="form-select">
                                    <option value="">All Sensor Types</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="rollup-section">
                        <div class="row" id="rollupContainer">
                            <!-- Rollup cards will be dynamically inserted here -->
                        </div>
                    </div>
                    <div id="alertContainer" class="row">
                        <!-- Alert cards will be dynamically inserted here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div w3-include-html="includes/footer.html"></div>
    <div w3-include-html="includes/login-modal.html"></div>

    <div id="loader" class="lds-roller loader">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/6.0.0/bootbox.min.js"></script>
    <script src="js/asnapp.js"></script>
    <script src="js/AretasGlobalInit.js"></script>
    <script>
        // (The JavaScript code remains the same as in the previous version)
        class AlertHistoryItem {

            constructor(data) {
                this.mac = data.mac;
                this.timestamp = data.timestamp;
                this.type = data.sensorType;
                this.typeStr = data.sensorTypeStr;
                this.data = data.sensorData;
                this.dataStr = data.sensorDataStr;
                this.alertId = data.alertId;
                this.isActive = data.isActive;
                this.eventId = data.eventId;
                this.rtnTimestamp = data.rtnTimestamp;
                this.device_description = data.device_description;
                this.alert_description = data.alert_description;
                this.location_description = data.location_description;
            }

            getStatusClass() {
                return this.isActive ? 'bg-danger text-white' : 'bg-success text-white';
            }

            getStatusText() {
                return this.isActive ? 'Active' : 'Resolved';
            }

            formatTimestamp(timestamp) {
                return new Date(timestamp).toLocaleString();
            }

            createCard() {
                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
                    <div class="alert-card">
                        <div class="alert-header ${this.getStatusClass()}">
                            <div class="sensortype-icon type-${this.type}"></div>Alert: ${this.alert_description}
                        </div>
                        <div class="alert-body">
                            <p><strong>Device:</strong> ${this.device_description} MAC:${this.mac}</p>
                            <p><strong>Building:</strong> ${this.location_description} <a href="#">View Map</a></p>
                            <p><strong>Status:</strong> ${this.getStatusText()}</p>
                            <p><strong>Download report:</strong>&nbsp;<i class="bi bi-filetype-pdf"></i></p>
                            <p><strong>Sensor Type:</strong> ${this.typeStr}</p>
                            <p><strong>Data:</strong> ${this.dataStr}</p>
                            <p><strong>Triggered:</strong> ${this.formatTimestamp(this.timestamp)}</p>
                            ${this.rtnTimestamp ? `<p><strong>Resolved:</strong> ${this.formatTimestamp(this.rtnTimestamp)}</p>` : ''}
                        </div>
                    </div>
                `;
                return card;
            }
        }

        class AlertDashboard {

            constructor(aretasAppInstance) {

                this.aai = aretasAppInstance;
                this.alertContainer = document.getElementById('alertContainer');
                this.rollupContainer = document.getElementById('rollupContainer');
                this.alertIdFilter = document.getElementById('alertIdFilter');
                this.sensorTypeFilter = document.getElementById('sensorTypeFilter');
                this.alerts = [];

                this.init();
            }

            async init() {

                this.alertsDefinitionList = await this.aai.listAlerts();
                this.fetchAlertNotices();
                this.setupEventListeners();
                setInterval(() => this.fetchAlertNotices(), 30000);
            }

            setupEventListeners() {
                this.alertIdFilter.addEventListener('change', () => this.filterAlerts());
                this.sensorTypeFilter.addEventListener('change', () => this.filterAlerts());
            }

            async fetchAlertNoticesAPI(alertIds) {

                const url = `${ASNAPIURL}alerthistory/list`;

                let classThis = this;

                let queryData = {};

                try {

                    showLoader();

                    let response = await globalFetch(url, {
                        method: 'POST',
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${appBearerToken}`,
                        },
                        body: JSON.stringify(
                            alertIds, // Pass the alertIds array in the request body
                        )
                    });

                    if (response.status != 200) {
                        return null;
                    }

                    let data = await response.json();
                    console.debug(data);
                    return data;

                } catch (error) {

                    console.error("Failed to query Alert Notices!");
                    console.error(error);

                } finally {
                    hideLoader();
                }

                return null;
            }

            getAlertObjById(alertId) {

                for (const alertObj of this.alertsDefinitionList) {
                    if (alertId == alertObj.id) {
                        return alertObj;
                    }
                }

                return null;

            }

            /**
             * decorate the alert notice with an alert description, device description, etc.
             */
            getAnnotatedAlertNotice(datum) {

                const alertObj = this.getAlertObjById(datum.alertId);

                let sensorTypeInfo = this.aai.getSensorTypeInfo(parseInt(datum.sensorType));
                let locationObj = this.aai.getLocationContainingMac(datum.mac);

                const ret = {
                    "alertId": datum.alertId,
                    "alert_description": alertObj?.description ?? "",
                    "device_description": this.aai.getSensorByMac(datum.mac).description,
                    "mac": datum.mac,
                    "location_description": locationObj.description,
                    "sensorData": datum.sensorData,
                    "sensorDataStr": `${datum.sensorData.toFixed(1)} ${sensorTypeInfo.units}`,
                    "sensorType": datum.sensorType,
                    "sensorTypeStr": sensorTypeInfo.label,
                    "timestamp": datum.timestamp,
                    "isActive": datum.isActive,
                    "rtnTimestamp": datum.rtnTimestamp,
                }

                return ret;

            }

            async fetchAlertNotices() {

                const alertIds = this.alertsDefinitionList.map(alertItem => alertItem.id);

                const alertNotices = await this.fetchAlertNoticesAPI(alertIds);

                console.log(alertNotices);
                this.alerts = alertNotices.map(datum => new AlertHistoryItem(this.getAnnotatedAlertNotice(datum)))

                this.updateFilters();
                this.renderAlerts();
                this.renderRollup();
            }

            updateFilters() {
                const alertIds = [...new Set(this.alerts.map(alert => alert.alertId))];
                const sensorTypes = [...new Set(this.alerts.map(alert => alert.type))];

                this.updateFilterOptions(this.alertIdFilter, alertIds, false);
                this.updateFilterOptions(this.sensorTypeFilter, sensorTypes, true);
            }

            updateFilterOptions(selectElement, options, isSensorType) {
                const currentValue = selectElement.value;
                selectElement.innerHTML = '<option value="">All</option>';
                const classThis = this;
                options.forEach(option => {

                    if (isSensorType) {

                        const sensorTypeObj = classThis.aai.getSensorTypeInfo(parseInt(option))
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = sensorTypeObj.label;
                        selectElement.appendChild(optionElement);

                    } else {

                        const alertObj = this.getAlertObjById(option);
                        const optionElement = document.createElement('option');
                        optionElement.value = option;
                        optionElement.textContent = alertObj.description;
                        selectElement.appendChild(optionElement);
                    }


                });
                selectElement.value = currentValue;
            }

            filterAlerts() {
                const alertId = this.alertIdFilter.value;
                const sensorType = this.sensorTypeFilter.value;

                const filteredAlerts = this.alerts.filter(alert =>
                    (!alertId || alert.alertId === alertId) &&
                    (!sensorType || alert.type === parseInt(sensorType))
                );

                this.renderAlerts(filteredAlerts);
            }

            renderAlerts(alertsToRender = this.alerts) {
                this.alertContainer.innerHTML = '';
                alertsToRender.forEach(alert => {
                    this.alertContainer.appendChild(alert.createCard());
                });
            }

            renderRollup() {
                const alertCount = {};
                this.alerts.forEach(alert => {
                    console.log(alert);
                    if (!alertCount[alert.alertId]) {
                        alertCount[alert.alertId] = {
                            count: 0,
                            alert_description: alert.alert_description,
                            alert_type: alert.sensorType,
                        };
                    }
                    alertCount[alert.alertId].count++;
                });

                this.rollupContainer.innerHTML = '';
                Object.keys(alertCount).forEach(alertId => {
                    const rollupCard = document.createElement('div');
                    rollupCard.className = 'col-md-6 col-lg-4'; /* Responsive column layout */

                    //let divIcon = document.createElement("div");
                    //divIcon.setAttribute("class", "sensortype-icon type-" + sensorReport.type);
                    const alertObj = this.getAlertObjById(alertId);
                    rollupCard.innerHTML = `
                        <div class="rollup-card">
                            <div class="rollup-card-header">
                                <div class="sensortype-icon type-${alertObj.sensorType}"></div>${alertCount[alertId].alert_description}
                            </div>
                            <div class="rollup-card-body">
                                <p>Number of Violations: <span class="count">${alertCount[alertId].count}</span></p>
                            </div>
                        </div>
                    `;
                    this.rollupContainer.appendChild(rollupCard);
                });
            }
        }


        document.addEventListener('DOMContentLoaded', async () => {
            aai = await app_init();
            new AlertDashboard(aai);
        });

    </script>
</body>

</html>